<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Workbook Compiler</title>
    <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f1f5f9;
            padding: 20px;
            color: #333;
        }

        .ui-container {
            max-width: 800px;
            margin: 0 auto 40px;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #1e40af;
            text-align: center;
        }

        .control-group {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #f8fafc;
            transition: all 0.2s;
        }

        .control-group.loaded {
            border-color: #10b981;
            background: #ecfdf5;
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
        }

        input[type="file"] {
            width: 100%;
        }

        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }

        button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }

        #status {
            margin-top: 15px;
            text-align: center;
            font-weight: bold;
        }

        /* File List Styles */
        #fileList {
            list-style: none;
            padding: 0;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        #fileList li {
            background: white;
            padding: 6px 10px;
            margin-bottom: 4px;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
        }

        .badge {
            background: #e0f2fe;
            color: #0369a1;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <!-- UI for file selection -->
    <div class="ui-container">
        <h1>Advanced Workbook Compiler</h1>
        <p>Generates a PDF-ready workbook with Title Page, Preface, TOC, and Page Numbers.</p>

        <div class="control-group" id="group-template">
            <label>1. HTML Template (workbook_template.html)</label>
            <input type="file" id="templateFile" accept=".html">
        </div>

        <div class="control-group" id="group-preface">
            <label>2. Preface Data (preface_data.json)</label>
            <input type="file" id="prefaceFile" accept=".json">
        </div>

        <div class="control-group" id="group-level">
            <label>3. Select Workbook Level</label>
            <select id="levelSelect" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #cbd5e1;">
                <option value="A1">A1 - Origins</option>
                <option value="A2">A2 - Quest</option>
                <option value="B1">B1 - Adventure</option>
                <option value="B2">B2 - Hero</option>
                <option value="C1">C1 - Legend</option>
            </select>
        </div>

        <div class="control-group" id="group-content">
            <label>4. Lesson Files (JSON + Images)</label>
            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Select <strong>all</strong> your content files (.json) and QR codes (.png/.jpg) together. The tool will pair them by filename.</div>
            <input type="file" id="contentFiles" accept=".json, .png, .jpg, .jpeg" multiple>
            <ul id="fileList"></ul>
        </div>

        <button id="compileBtn" disabled>Compile Workbook</button>
        <div id="status"></div>
    </div>

    <script>
        const templateInput = document.getElementById('templateFile');
        const prefaceInput = document.getElementById('prefaceFile');
        const contentInput = document.getElementById('contentFiles');
        const levelSelect = document.getElementById('levelSelect');
        const compileBtn = document.getElementById('compileBtn');
        const statusDiv = document.getElementById('status');
        const fileList = document.getElementById('fileList');

        // Check file inputs state and update UI
        function checkInputs() {
            // Update visual state for each group
            document.getElementById('group-template').classList.toggle('loaded', templateInput.files.length > 0);
            document.getElementById('group-preface').classList.toggle('loaded', prefaceInput.files.length > 0);
            document.getElementById('group-content').classList.toggle('loaded', contentInput.files.length > 0);

            // Enable button only if all required inputs have files
            if (templateInput.files.length > 0 && prefaceInput.files.length > 0 && contentInput.files.length > 0) {
                compileBtn.disabled = false;
                compileBtn.textContent = `Compile Workbook`;
            } else {
                compileBtn.disabled = true;
                compileBtn.textContent = "Compile Workbook";
            }
        }

        // Listeners for simple single-file inputs
        templateInput.addEventListener('change', checkInputs);
        prefaceInput.addEventListener('change', checkInputs);

        // Special listener for content files to update list
        contentInput.addEventListener('change', (e) => {
            fileList.innerHTML = ''; // Clear list

            if (e.target.files.length > 0) {
                const files = Array.from(e.target.files);
                const jsonFiles = files.filter(f => f.name.toLowerCase().endsWith('.json'));
                const imgFiles = files.filter(f => !f.name.toLowerCase().endsWith('.json'));
                
                // Sort files by name to ensure logical order
                jsonFiles.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true }));

                compileBtn.textContent = `Compile Workbook (${jsonFiles.length} Lessons)`;

                jsonFiles.forEach((file, index) => {
                    // Check if matching image exists
                    const baseName = file.name.substring(0, file.name.lastIndexOf('.'));
                    const hasImage = imgFiles.some(img => img.name.startsWith(baseName));
                    
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span>${file.name}</span> 
                        <div>
                            ${hasImage ? '<span class="badge" style="background:#dcfce7; color:#166534">QR Found</span>' : ''}
                            <span class="badge">Lesson ${index + 1}</span>
                        </div>`;
                    fileList.appendChild(li);
                });
            }
            checkInputs();
        });

        // Helper to read file text
        const readFile = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = reject;
            reader.readAsText(file);
        });

        // Helper to read file as Data URL
        const readDataUrl = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });

        // Helper to generate QR code as SVG data URL
        const generateQRCode = (url) => {
            try {
                // Use qrcode-generator library (loaded via CDN)
                // Error correction level: L=7%, M=15%, Q=25%, H=30%
                const typeNumber = 0; // Auto-detect size
                const errorCorrectionLevel = 'M';
                const qr = qrcode(typeNumber, errorCorrectionLevel);
                qr.addData(url);
                qr.make();

                // Generate SVG with proper scaling for print
                const cellSize = 10; // pixels per module
                const margin = 1; // quiet zone
                const size = qr.getModuleCount();
                const totalSize = (size + margin * 2) * cellSize;

                let svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${totalSize}" height="${totalSize}" viewBox="0 0 ${totalSize} ${totalSize}">`;
                svg += `<rect width="100%" height="100%" fill="#ffffff"/>`;
                svg += `<g transform="translate(${margin * cellSize}, ${margin * cellSize})">`;

                for (let row = 0; row < size; row++) {
                    for (let col = 0; col < size; col++) {
                        if (qr.isDark(row, col)) {
                            svg += `<rect x="${col * cellSize}" y="${row * cellSize}" width="${cellSize}" height="${cellSize}" fill="#000000"/>`;
                        }
                    }
                }

                svg += '</g></svg>';

                // Convert SVG to data URL
                return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
            } catch (error) {
                console.error('QR code generation failed:', error);
                return null;
            }
        };

        compileBtn.addEventListener('click', async () => {
            statusDiv.textContent = "Compiling...";
            statusDiv.style.color = "blue";

            try {
                // 1. Read all files
                const templateHtml = await readFile(templateInput.files[0]);
                const prefaceJson = JSON.parse(await readFile(prefaceInput.files[0]));
                const selectedLevel = levelSelect.value; 

                // Process Content Files
                const allFiles = Array.from(contentInput.files);
                const jsonFiles = allFiles.filter(f => f.name.toLowerCase().endsWith('.json'));
                const imgFiles = allFiles.filter(f => !f.name.toLowerCase().endsWith('.json'));

                // Create Image Map (filename -> dataURL)
                const imgMap = {};
                for (const img of imgFiles) {
                    const baseName = img.name.substring(0, img.name.lastIndexOf('.'));
                    imgMap[baseName] = await readDataUrl(img);
                }

                // Sort JSONs
                jsonFiles.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true }));

                // 2. Determine Book Metadata
                const levelKey = selectedLevel; 
                const preface = prefaceJson[levelKey] || prefaceJson["A1"];
                let seriesName = "Series";
                let seriesTagline = "";
                
                if (preface.title.includes("—")) {
                    const parts = preface.title.split("—");
                    seriesName = parts[0].trim();
                    seriesTagline = parts[1].trim();
                } else {
                    seriesName = preface.title;
                }

                const lessons = [];
                for (let i = 0; i < jsonFiles.length; i++) {
                    const file = jsonFiles[i];
                    const json = JSON.parse(await readFile(file));
                    const baseName = file.name.substring(0, file.name.lastIndexOf('.'));

                    // FORCE SEQUENTIAL NUMBERING
                    json.lesson_number = `Lesson ${i + 1}`;
                    
                    // INJECT METADATA
                    json.series_name = seriesName;
                    json.level_name = levelKey; 
                    json.cefr_level = levelKey; // Ensure consistency
                    json.series_tagline = seriesTagline;

                    // INJECT QR CODE
                    // Priority 1: Manual QR image (if provided)
                    if (imgMap[baseName]) {
                        json.qr_code_url = imgMap[baseName];
                    }
                    // Priority 2: Auto-generate from article_url
                    else if (json.article_url) {
                        const qrDataUrl = generateQRCode(json.article_url);
                        if (qrDataUrl) {
                            json.qr_code_url = qrDataUrl;
                        }
                    }

                    lessons.push(json);
                }

                // 3. Extract Styles from Template
                const parser = new DOMParser();
                const doc = parser.parseFromString(templateHtml, 'text/html');

                // Extract CSS and Links
                // We strip the .workbook-container style because Paged.js handles the page box better without it
                const styles = Array.from(doc.querySelectorAll('style')).map(s => s.innerText).join('\n')
                    .replace(/\.workbook-container\s*{[^}]*}/g, '')
                    .replace(/@page\s*{[^}]*}/g, '') /* Strip conflicting @page rules from template */
                    .replace(/body\s*{[^}]*}/g, 'body { font-family: "Open Sans", sans-serif; }'); /* Strip body padding/margins but keep font */

                const links = Array.from(doc.querySelectorAll('link')).map(l => l.outerHTML).join('\n');

                // 4. Compile Lessons
                // FIX: Use Regex to extract body content to preserve Handlebars syntax in tables
                // DOMParser moves {{#each}} out of <table>/<tbody> because it's invalid HTML text
                const bodyMatch = templateHtml.match(/<body[^>]*>([\s\S]*)<\/body>/i);
                const bodyTemplate = bodyMatch ? bodyMatch[1] : doc.body.innerHTML;
                
                const hbTemplate = Handlebars.compile(bodyTemplate);

                let lessonsHtml = "";
                let tocItems = "";

                lessons.forEach((lesson, index) => {
                    const lessonId = `lesson-${index}`;

                    // Generate Lesson Content
                    const content = hbTemplate(lesson);

                    // IMPORTANT: Unwrap content from .workbook-container if it exists in the template
                    // This prevents double-boxing which can break Paged.js layout
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = content;
                    const innerContent = tempDiv.querySelector('.workbook-container') ? tempDiv.querySelector('.workbook-container').innerHTML : content;

                    lessonsHtml += `<div id="${lessonId}" class="lesson-section">${innerContent}</div>`;

                    // Generate TOC Item with automatic page numbering target
                    tocItems += `
                        <li class="toc-item">
                            <a href="#${lessonId}">
                                <span class="toc-text">${lesson.lesson_number}: ${lesson.lesson_title}</span>
                                <span class="toc-meta">(${lesson.genre} / ${lesson.article_type})</span>
                            </a>
                        </li>
                    `;
                });

                // Format preface paragraphs
                const formattedPreface = preface.text.split('\n\n')
                    .map(p => `<p>${p}</p>`)
                    .join('');

                // 5. Construct Final HTML Document
                const finalHtml = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Reading Advantage Workbook - ${seriesName}</title>
    <script src="https://unpkg.com/pagedjs/dist/paged.polyfill.js"><\/script>
    ${links}
    <style>
        ${styles}

        /* --- Paged.js Configuration --- */
        @page {
            size: Letter;
            margin: 20mm;
            
            @bottom-center {
                content: "Page " counter(page);
                font-family: 'Open Sans', sans-serif;
                font-size: 10pt;
            }
        }

        /* Front Matter Pages (Title, Preface, TOC) do not show page numbers usually, 
           or show Roman numerals. For simplicity, we hide them on the Title Page 
           and let them run on others, or we could reset the counter. 
           Let's hide on Title Page only. */
        @page:first {
            margin: 0;
            @bottom-center { content: none; }
        }
        
        /* --- Preview Styles --- */
        body {
            background-color: #555;
            margin: 0;
            padding: 0; 
        }
        .pagedjs_pages {
            display: flex;
            width: calc(var(--pagedjs-width) * 2);
            min-width: 200%;
            flex-direction: column;
            align-items: center;
            margin: 0 auto;
            padding: 20px 0;
        }
        .pagedjs_page {
            background: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        /* --- Print Overrides to Fix Scaling --- */
        @media print {
            body { 
                background: white; 
                width: 100%;
                margin: 0;
                padding: 0;
            }
            .pagedjs_pages {
                display: block !important;
                width: 100% !important;
                min-width: 0 !important;
                transform: none !important;
            }
            .pagedjs_page {
                margin: 0 !important;
                box-shadow: none !important;
                page-break-after: always;
            }
        }

        /* --- Title Page --- */
        .title-page {
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            break-after: page;
            background: white;
            color: black;
            padding: 40px;
            box-sizing: border-box;
        }
        .tp-main-title { 
            font-size: 24pt; 
            margin-bottom: 20px; 
            font-weight: normal; 
            font-family: 'Merriweather', serif;
        }
        .tp-series-title { 
            font-size: 48pt; 
            font-weight: bold; 
            margin-bottom: 10px; 
            text-transform: uppercase; 
            font-family: 'Open Sans', sans-serif;
            color: #1e40af;
        }
        .tp-level-info { 
            font-size: 18pt; 
            margin-bottom: 50px; 
            color: #555;
        }
        .tp-tagline { 
            font-size: 16pt; 
            font-style: italic; 
            margin-top: auto; 
            margin-bottom: 80px; 
        }
        .tp-publisher { 
            font-size: 10pt; 
            margin-bottom: 40px; 
            color: #888;
        }

        /* --- Sections --- */
        .section-preface, .section-toc {
            break-after: page;
            padding-top: 40px; 
            font-family: 'Open Sans', sans-serif;
        }
        
        .section-header {
            font-size: 24pt;
            border-bottom: 2px solid #1e40af;
            color: #1e40af;
            padding-bottom: 10px;
            margin-bottom: 30px;
            text-align: left;
        }

        .preface-content {
            font-size: 12pt;
            line-height: 1.6;
            text-align: justify;
        }

        ul.toc-list {
            list-style: none;
            padding: 0;
        }
        
        li.toc-item {
            margin-bottom: 12px;
        }
        
        li.toc-item a {
            text-decoration: none;
            color: inherit;
            display: flex;
            align-items: baseline;
        }
        
        /* Leader dots and page number using CSS target-counter */
        li.toc-item a::after {
            content: target-counter(attr(href), page);
            float: right;
            font-weight: bold;
            margin-left: 10px;
        }
        
        li.toc-item a .toc-text { font-weight: bold; }
        
        li.toc-item a .toc-meta {
            font-size: 0.9em;
            color: #666;
            margin-left: 10px;
            font-style: italic;
            flex-grow: 1;
            border-bottom: 1px dotted #ccc;
            margin-right: 5px;
        }

        .lesson-section {
            break-after: page;
        }
        
        /* Fix: Prevent trailing margins from creating a blank page after the lesson */
        .lesson-section > *:last-child {
            margin-bottom: 0 !important;
        }
        
        /* Fix spacing for Paged.js flow */
        .lesson-header { margin-top: 0; }
        
        /* Prevent awkward breaks */
        .question-box, .practice-box, .vocab-table tr {
            break-inside: avoid;
        }
    </style>
</head>
<body>
    <!-- Title Page -->
    <div class="title-page">
        <h1 class="tp-main-title">Reading Advantage</h1>
        <h2 class="tp-series-title">${seriesName}</h2>
        <div class="tp-level-info">Level ${levelKey}</div>
        <div class="tp-tagline">${seriesTagline}</div>
        <div class="tp-publisher">Reading Advantage Series • 2025 Edition</div>
    </div>

    <!-- Preface Page -->
    <div class="section-preface">
        <h2 class="section-header">Preface</h2>
        <div class="preface-content">
            ${formattedPreface}
        </div>
    </div>

    <!-- TOC Page -->
    <div class="section-toc">
        <h2 class="section-header">Table of Contents</h2>
        <ul class="toc-list">
            ${tocItems}
        </ul>
    </div>

    <!-- Lessons -->
    ${lessonsHtml}
</body>
</html>`;

                // 6. Open in New Window
                const newWindow = window.open('', '_blank');
                if (!newWindow) throw new Error("Popup blocked! Allow popups to see the workbook.");

                newWindow.document.write(finalHtml);
                newWindow.document.close();

                statusDiv.textContent = "Success! Workbook generated in new tab.";
                statusDiv.style.color = "green";

            } catch (err) {
                console.error(err);
                statusDiv.textContent = "Error: " + err.message;
                statusDiv.style.color = "red";
            }
        });
    </script>
</body>

</html>